/**
 * Modern Admin Styler V2 - Main Application Orchestrator
 * G≈Ç√≥wny koordynator wszystkich modu≈Ç√≥w aplikacji
 */

class ModernAdminApp {
    constructor() {
        this.modules = new Map();
        this.settings = {};
        this.isInitialized = false;
        this.initPromise = null;
    }
    
    async init(initialSettings = {}) {
        if (this.initPromise) {
            return this.initPromise;
        }
        
        this.initPromise = this._initializeApp(initialSettings);
        return this.initPromise;
    }
    
    async _initializeApp(initialSettings) {
        try {
            console.log('üöÄ Inicjalizacja Modern Admin Styler V2...');
            
            this.settings = initialSettings;
            this.setupGlobalEventListeners();
            
            // Inicjalizuj modu≈Çy w odpowiedniej kolejno≈õci
            await this.initializeModules();
            
            // Ustaw poczƒÖtkowy stan
            this.applyInitialSettings();
            
            this.isInitialized = true;
            this.dispatchAppEvent('initialized');
            
            console.log('‚úÖ Modern Admin Styler V2 zainicjalizowany pomy≈õlnie');
            
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd podczas inicjalizacji Modern Admin Styler V2:', error);
            this.dispatchAppEvent('init-error', { error });
            throw error;
        }
    }
    
    async initializeModules() {
        const moduleConfigs = [
            {
                name: 'themeManager',
                class: ThemeManager,
                priority: 1,
                global: true // ≈Åadowane na wszystkich stronach
            },
            {
                name: 'bodyClassManager',
                class: BodyClassManager,
                priority: 2,
                global: true
            },
            {
                name: 'menuManager',
                class: MenuManager,
                priority: 3,
                global: true
            },
            {
                name: 'notificationManager',
                class: NotificationManager,
                priority: 3.5,
                global: true
            },
            {
                name: 'livePreviewManager',
                class: LivePreviewManager,
                priority: 4,
                global: false // Tylko na stronie ustawie≈Ñ
            },
            {
                name: 'settingsManager',
                class: SettingsManager,
                priority: 5,
                global: false // Tylko na stronie ustawie≈Ñ
            },
            {
                name: 'paletteManager',
                class: PaletteManager,
                priority: 2.5,
                global: true // Dostƒôpne globalnie
            }
        ];
        
        // Sortuj wed≈Çug priorytetu
        moduleConfigs.sort((a, b) => a.priority - b.priority);
        
        // Sprawd≈∫ czy jeste≈õmy na stronie ustawie≈Ñ
        const isSettingsPage = this.isSettingsPage();
        
        for (const config of moduleConfigs) {
            try {
                // Sprawd≈∫ czy modu≈Ç powinien byƒá ≈Çadowany
                if (!config.global && !isSettingsPage) {
                    continue;
                }
                
                // Sprawd≈∫ czy klasa jest dostƒôpna
                if (typeof config.class !== 'function') {
                    console.warn(`Klasa ${config.class.name} nie jest dostƒôpna`);
                    continue;
                }
                
                console.log(`üì¶ Inicjalizacja modu≈Çu: ${config.name}`);
                
                const moduleInstance = new config.class(this);
                
                // Modu≈Çy globalne u≈ºywajƒÖ ustawie≈Ñ, modu≈Çy lokalne mogƒÖ mieƒá w≈ÇasnƒÖ logikƒô
                if (config.global) {
                    moduleInstance.init(this.settings);
                } else {
                    moduleInstance.init();
                }
                
                this.modules.set(config.name, moduleInstance);
                
                console.log(`‚úÖ Modu≈Ç ${config.name} zainicjalizowany`);
                
            } catch (error) {
                console.error(`‚ùå B≈ÇƒÖd podczas inicjalizacji modu≈Çu ${config.name}:`, error);
                this.dispatchAppEvent('module-error', { 
                    module: config.name, 
                    error 
                });
            }
        }
    }
    
    isSettingsPage() {
        // Sprawd≈∫ czy jeste≈õmy na stronie ustawie≈Ñ wtyczki
        const url = window.location.href;
        return url.includes('page=modern-admin-styler') || 
               url.includes('mas-v2-settings') ||
               document.querySelector('#mas-v2-settings-form') !== null;
    }
    
    setupGlobalEventListeners() {
        // Nas≈Çuchuj zmian ustawie≈Ñ i propaguj do modu≈Ç√≥w
        document.addEventListener('mas-settings-changed', (e) => {
            this.settings = { ...this.settings, ...e.detail.settings };
            this.propagateSettingsToModules();
        });
        
        // Nas≈Çuchuj b≈Çƒôd√≥w modu≈Ç√≥w
        document.addEventListener('mas-module-error', (e) => {
            console.error('B≈ÇƒÖd modu≈Çu:', e.detail);
        });
        
        // Cleanup przy unload
        window.addEventListener('beforeunload', () => {
            this.destroy();
        });
    }
    
    applyInitialSettings() {
        // Zastosuj ustawienia poczƒÖtkowe do wszystkich modu≈Ç√≥w
        this.propagateSettingsToModules();
        
        // Wy≈õlij event o za≈Çadowaniu ustawie≈Ñ
        this.dispatchAppEvent('settings-applied', this.settings);
    }
    
    propagateSettingsToModules() {
        this.modules.forEach((module, name) => {
            try {
                if (typeof module.updateSettings === 'function') {
                    module.updateSettings(this.settings);
                } else if (typeof module.applySettings === 'function') {
                    module.applySettings(this.settings);
                }
            } catch (error) {
                console.error(`B≈ÇƒÖd podczas aktualizacji ustawie≈Ñ modu≈Çu ${name}:`, error);
            }
        });
    }
    
    // Publiczne API dla modu≈Ç√≥w
    getModule(name) {
        return this.modules.get(name);
    }
    
    hasModule(name) {
        return this.modules.has(name);
    }
    
    getAllModules() {
        return new Map(this.modules);
    }
    
    getSettings() {
        return { ...this.settings };
    }
    
    updateSettings(newSettings) {
        this.settings = { ...this.settings, ...newSettings };
        this.propagateSettingsToModules();
        this.dispatchAppEvent('settings-updated', this.settings);
    }
    
    // API dla zewnƒôtrznych skrypt√≥w
    enableFloatingMenu() {
        const bodyManager = this.getModule('bodyClassManager');
        const menuManager = this.getModule('menuManager');
        
        if (bodyManager) {
            bodyManager.enableFloatingMenu();
        }
        
        if (menuManager) {
            menuManager.setFloating(true);
        }
        
        this.updateSettings({ menu_detached: true });
    }
    
    disableFloatingMenu() {
        const bodyManager = this.getModule('bodyClassManager');
        const menuManager = this.getModule('menuManager');
        
        if (bodyManager) {
            bodyManager.disableFloatingMenu();
        }
        
        if (menuManager) {
            menuManager.setFloating(false);
        }
        
        this.updateSettings({ menu_detached: false });
    }
    
    toggleTheme() {
        const themeManager = this.getModule('themeManager');
        if (themeManager) {
            themeManager.toggleTheme();
        }
    }
    
    enableLivePreview() {
        const livePreview = this.getModule('livePreviewManager');
        if (livePreview) {
            livePreview.enable();
        }
    }
    
    disableLivePreview() {
        const livePreview = this.getModule('livePreviewManager');
        if (livePreview) {
            livePreview.disable();
        }
    }
    
    saveSettings() {
        const settingsManager = this.getModule('settingsManager');
        if (settingsManager) {
            return settingsManager.saveSettings();
        }
        return Promise.reject(new Error('SettingsManager nie jest dostƒôpny'));
    }
    
    exportSettings() {
        const settingsManager = this.getModule('settingsManager');
        if (settingsManager) {
            return settingsManager.exportSettings();
        }
        throw new Error('SettingsManager nie jest dostƒôpny');
    }
    
    // Debugging i diagnostyka
    getSystemInfo() {
        const info = {
            isInitialized: this.isInitialized,
            isSettingsPage: this.isSettingsPage(),
            loadedModules: Array.from(this.modules.keys()),
            settings: this.settings,
            modules: {}
        };
        
        this.modules.forEach((module, name) => {
            try {
                if (typeof module.getCurrentState === 'function') {
                    info.modules[name] = module.getCurrentState();
                } else {
                    info.modules[name] = { status: 'active' };
                }
            } catch (error) {
                info.modules[name] = { status: 'error', error: error.message };
            }
        });
        
        return info;
    }
    
    logSystemInfo() {
        console.group('üîç Modern Admin Styler V2 - System Info');
        console.log(this.getSystemInfo());
        console.groupEnd();
    }
    
    // Event system
    dispatchAppEvent(eventType, data = null) {
        const event = new CustomEvent(`mas-app-${eventType}`, {
            detail: {
                app: this,
                eventType,
                data,
                timestamp: Date.now()
            }
        });
        document.dispatchEvent(event);
    }
    
    // Cleanup
    destroy() {
        console.log('üßπ Czyszczenie Modern Admin Styler V2...');
        
        this.modules.forEach((module, name) => {
            try {
                if (typeof module.destroy === 'function') {
                    module.destroy();
                    console.log(`‚úÖ Modu≈Ç ${name} wyczyszczony`);
                }
            } catch (error) {
                console.error(`‚ùå B≈ÇƒÖd podczas czyszczenia modu≈Çu ${name}:`, error);
            }
        });
        
        this.modules.clear();
        this.isInitialized = false;
        this.initPromise = null;
        
        this.dispatchAppEvent('destroyed');
    }
    
    // Singleton pattern dla globalnego dostƒôpu
    static getInstance() {
        if (!ModernAdminApp.instance) {
            ModernAdminApp.instance = new ModernAdminApp();
        }
        return ModernAdminApp.instance;
    }
}

// Globalna instancja
window.ModernAdminApp = ModernAdminApp;

// Auto-inicjalizacja je≈õli mamy dane
if (typeof masV2Global !== 'undefined' && masV2Global.settings) {
    document.addEventListener('DOMContentLoaded', () => {
        const app = ModernAdminApp.getInstance();
        app.init(masV2Global.settings).catch(error => {
            console.error('B≈ÇƒÖd auto-inicjalizacji:', error);
        });
    });
}

// Eksport dla u≈ºycia w innych modu≈Çach
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ModernAdminApp;
} 
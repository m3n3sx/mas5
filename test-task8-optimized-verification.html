<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 8: Optimized Simple Live Preview Verification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f1f1f1;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .test-section h4 {
            margin-top: 0;
            color: #0073aa;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        .preview-area {
            background: #2c3338;
            padding: 15px;
            border-radius: 8px;
            color: white;
            min-height: 200px;
        }
        
        .admin-bar-demo {
            background: #23282d;
            height: 32px;
            border-radius: 4px;
            margin: 10px 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 13px;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .test-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .test-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-warn { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        
        button:hover { background: #005a87; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        
        .range-display {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #0073aa;
            font-size: 12px;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin-top: 10px;
        }
        
        .health-meter {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s ease;
        }
        
        .error-recovery-tests {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Task 8: Optimized Simple Live Preview System</h1>
        <p><strong>Testing:</strong> Live preview functionality without Phase 3 dependencies, CSS injection optimization, and comprehensive error recovery</p>
        
        <div id="test-results"></div>
        
        <div class="test-grid">
            <!-- Live Preview Controls -->
            <div class="test-section">
                <h4>Live Preview Controls</h4>
                
                <div class="form-group">
                    <label for="primary_color">Primary Color</label>
                    <input type="color" id="primary_color" name="mas_v2_settings[primary_color]" 
                           class="mas-v2-color" value="#0073aa">
                </div>
                
                <div class="form-group">
                    <label for="secondary_color">Secondary Color</label>
                    <input type="color" id="secondary_color" name="mas_v2_settings[secondary_color]" 
                           class="mas-v2-color" value="#23282d">
                </div>
                
                <div class="form-group">
                    <label for="font_size">Font Size (px)</label>
                    <input type="number" id="font_size" name="mas_v2_settings[font_size]" 
                           class="mas-v2-input" value="14" min="10" max="24">
                </div>
                
                <div class="form-group">
                    <label for="border_radius">Border Radius</label>
                    <input type="range" id="border_radius" name="mas_v2_settings[border_radius]" 
                           class="mas-v2-slider" min="0" max="20" value="4">
                    <span class="range-display" id="border-radius-value">4px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable_animations" name="mas_v2_settings[enable_animations]" 
                               class="mas-v2-checkbox" checked>
                        Enable Animations
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="theme_style">Theme Style</label>
                    <select id="theme_style" name="mas_v2_settings[theme_style]" class="mas-v2-select">
                        <option value="modern">Modern</option>
                        <option value="classic">Classic</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>
            </div>
            
            <!-- Preview Area -->
            <div class="test-section">
                <h4>Live Preview Area</h4>
                <div class="preview-area">
                    <div class="admin-bar-demo" id="admin-bar-demo">
                        WordPress Admin Bar
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 12px;">
                        <p>Live CSS injection demo</p>
                        <p>Changes appear instantly</p>
                    </div>
                </div>
                
                <div class="status-display" id="injected-styles">
                    No styles injected yet...
                </div>
            </div>
            
            <!-- System Status -->
            <div class="test-section">
                <h4>System Status</h4>
                
                <div>
                    <strong>Health Score:</strong>
                    <div class="health-meter">
                        <div class="health-bar" id="health-bar" style="width: 0%"></div>
                    </div>
                    <div id="health-score">Calculating...</div>
                </div>
                
                <div class="status-display" id="system-status">
                    Loading system status...
                </div>
                
                <div style="margin-top: 10px;">
                    <button onclick="runHealthCheck()">Health Check</button>
                    <button onclick="runDiagnostics()">Run Diagnostics</button>
                    <button onclick="testConnection()">Test Connection</button>
                </div>
            </div>
        </div>
        
        <!-- Error Recovery Tests -->
        <div class="test-container">
            <h3>Error Recovery & Resilience Tests</h3>
            <p>Test how the optimized system handles various failure scenarios and recovers gracefully:</p>
            
            <div class="error-recovery-tests">
                <button onclick="testNetworkFailure()">Network Failure</button>
                <button onclick="testInvalidResponse()">Invalid Response</button>
                <button onclick="testMissingNonce()">Missing Nonce</button>
                <button onclick="testEmptyCSS()">Empty CSS</button>
                <button onclick="testInvalidCSS()">Invalid CSS</button>
                <button onclick="testServerError()">Server Error</button>
                <button class="danger" onclick="testCriticalFailure()">Critical Failure</button>
                <button class="success" onclick="restoreNormalOperation()">Restore Normal</button>
            </div>
            
            <div id="error-test-results" class="test-status test-info">
                Ready to run error recovery tests...
            </div>
        </div>
        
        <div class="console-output" id="console-output">
            <div>Console output will appear here...</div>
        </div>
    </div>

    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Mock WordPress Color Picker -->
    <script>
        if (typeof jQuery !== 'undefined') {
            jQuery.fn.wpColorPicker = function(options) {
                return this.each(function() {
                    var $input = jQuery(this);
                    $input.on('change', function() {
                        if (options && options.change) {
                            options.change.call(this, null, {
                                color: {
                                    toString: function() {
                                        return $input.val();
                                    }
                                }
                            });
                        }
                    });
                });
            };
        }
    </script>
    
    <!-- Mock masV2Global -->
    <script>
        var masV2Global = {
            ajaxUrl: window.location.href,
            nonce: 'test_nonce_123',
            settings: {
                primary_color: '#0073aa',
                secondary_color: '#23282d',
                font_size: '14',
                border_radius: '4',
                enable_animations: true,
                theme_style: 'modern'
            }
        };
        
        // Enhanced mock AJAX handler with error simulation
        var originalPost = jQuery.post;
        var mockSettings = {
            enabled: true,
            delay: 300,
            failureRate: 0, // 0 = no failures, 1 = always fail
            responseType: 'success' // 'success', 'error', 'invalid', 'empty'
        };
        
        jQuery.post = function(url, data, success, dataType) {
            if (data.action === 'mas_v2_get_preview_css' && mockSettings.enabled) {
                var shouldFail = Math.random() < mockSettings.failureRate;
                
                setTimeout(function() {
                    if (shouldFail || mockSettings.responseType === 'error') {
                        // Simulate network error
                        var mockXHR = {
                            status: 500,
                            statusText: 'Internal Server Error',
                            responseText: 'Mock server error'
                        };
                        
                        return {
                            done: function() { return this; },
                            fail: function(callback) {
                                callback(mockXHR, 'error', 'Internal Server Error');
                                return this;
                            },
                            always: function(callback) {
                                setTimeout(callback, 50);
                                return this;
                            }
                        };
                    }
                    
                    var response;
                    switch (mockSettings.responseType) {
                        case 'invalid':
                            response = { success: false, data: { message: 'Invalid request' } };
                            break;
                        case 'empty':
                            response = { success: true, data: { css: '', setting: data.setting, value: data.value } };
                            break;
                        case 'malformed':
                            response = { invalid: 'response' };
                            break;
                        default:
                            var css = generateMockCSS(data.setting, data.value);
                            response = {
                                success: true,
                                data: {
                                    css: css,
                                    setting: data.setting,
                                    value: data.value,
                                    performance: {
                                        execution_time_ms: Math.floor(Math.random() * 50) + 10
                                    }
                                }
                            };
                    }
                    
                    if (success) {
                        success(response);
                    }
                }, mockSettings.delay);
                
                return {
                    done: function(callback) {
                        setTimeout(function() {
                            if (!shouldFail && mockSettings.responseType !== 'error') {
                                var response;
                                switch (mockSettings.responseType) {
                                    case 'invalid':
                                        response = { success: false, data: { message: 'Invalid request' } };
                                        break;
                                    case 'empty':
                                        response = { success: true, data: { css: '', setting: data.setting, value: data.value } };
                                        break;
                                    case 'malformed':
                                        response = { invalid: 'response' };
                                        break;
                                    default:
                                        var css = generateMockCSS(data.setting, data.value);
                                        response = {
                                            success: true,
                                            data: {
                                                css: css,
                                                setting: data.setting,
                                                value: data.value,
                                                performance: {
                                                    execution_time_ms: Math.floor(Math.random() * 50) + 10
                                                }
                                            }
                                        };
                                }
                                callback(response);
                            }
                        }, mockSettings.delay);
                        return this;
                    },
                    fail: function(callback) {
                        if (shouldFail || mockSettings.responseType === 'error') {
                            setTimeout(function() {
                                var mockXHR = {
                                    status: 500,
                                    statusText: 'Internal Server Error',
                                    responseText: 'Mock server error'
                                };
                                callback(mockXHR, 'error', 'Internal Server Error');
                            }, mockSettings.delay);
                        }
                        return this;
                    },
                    always: function(callback) {
                        setTimeout(callback, mockSettings.delay + 50);
                        return this;
                    }
                };
            }
            
            return originalPost.apply(this, arguments);
        };
        
        function generateMockCSS(setting, value) {
            switch (setting) {
                case 'primary_color':
                    return `.wp-admin { --primary-color: ${value}; } .admin-bar-demo { background-color: ${value}; }`;
                case 'secondary_color':
                    return `.wp-admin { --secondary-color: ${value}; } .preview-area { background-color: ${value}; }`;
                case 'font_size':
                    return `.wp-admin { font-size: ${value}px; } .admin-bar-demo { font-size: ${value}px; }`;
                case 'border_radius':
                    return `.wp-admin { --border-radius: ${value}px; } .admin-bar-demo { border-radius: ${value}px; }`;
                case 'enable_animations':
                    return value ? `.wp-admin { transition: all 0.3s ease; } .admin-bar-demo { transition: all 0.3s ease; }` : `.wp-admin { transition: none; } .admin-bar-demo { transition: none; }`;
                case 'theme_style':
                    var styles = {
                        modern: '.wp-admin { --theme: modern; } .admin-bar-demo { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }',
                        classic: '.wp-admin { --theme: classic; } .admin-bar-demo { border: 1px solid #ccc; }',
                        minimal: '.wp-admin { --theme: minimal; } .admin-bar-demo { background: transparent; border: 1px solid #666; }'
                    };
                    return styles[value] || styles.modern;
                default:
                    return `/* Setting: ${setting} = ${value} */`;
            }
        }
    </script>
    
    <!-- Load Optimized Simple Live Preview -->
    <script src="assets/js/simple-live-preview.js"></script>
    
    <script>
        // Console output capture
        var originalLog = console.log;
        var originalError = console.error;
        var consoleOutput = document.getElementById('console-output');
        
        function addToConsole(message, type = 'log') {
            var div = document.createElement('div');
            div.style.color = type === 'error' ? '#ff6b6b' : '#00ff00';
            div.style.marginBottom = '2px';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // Monitor CSS injection
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.tagName === 'STYLE' && node.id === 'mas-preview-styles') {
                            var injectedStyles = document.getElementById('injected-styles');
                            var cssContent = node.textContent || 'Empty CSS';
                            injectedStyles.textContent = cssContent.length > 200 ? 
                                cssContent.substring(0, 200) + '...' : cssContent;
                            console.log('CSS injected: ' + (node.textContent ? node.textContent.length + ' characters' : 'empty'));
                        }
                    });
                }
            });
        });
        
        observer.observe(document.head, { childList: true });
        
        // Update range display
        jQuery('#border_radius').on('input', function() {
            jQuery('#border-radius-value').text(jQuery(this).val() + 'px');
        });
        
        // System monitoring functions
        function updateSystemStatus() {
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                var status = window.MASSimpleLivePreview.getStatus();
                var statusDisplay = document.getElementById('system-status');
                
                statusDisplay.innerHTML = 
                    'Fallback Mode: ' + (status.fallbackMode ? 'ACTIVE' : 'INACTIVE') + '<br>' +
                    'Retry Count: ' + status.retryCount + '<br>' +
                    'Last Success: ' + (status.lastSuccessfulRequest ? 
                        new Date(status.lastSuccessfulRequest).toLocaleTimeString() : 'Never') + '<br>' +
                    'Diagnostics: ' + (status.diagnosticsEnabled ? 'ENABLED' : 'DISABLED');
            }
        }
        
        function runHealthCheck() {
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                var healthScore = window.MASSimpleLivePreview.performHealthCheck();
                var percentage = Math.round((healthScore / 5) * 100);
                
                var healthBar = document.getElementById('health-bar');
                var healthScoreDisplay = document.getElementById('health-score');
                
                healthBar.style.width = percentage + '%';
                healthScoreDisplay.textContent = healthScore + '/5 (' + percentage + '%)';
                
                updateSystemStatus();
            }
        }
        
        function runDiagnostics() {
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                var result = window.MASSimpleLivePreview.runDiagnostics();
                console.log('Diagnostics result: ' + (result ? 'PASS' : 'FAIL'));
            }
        }
        
        function testConnection() {
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                window.MASSimpleLivePreview.testConnectionRecovery();
            }
        }
        
        // Error testing functions
        function testNetworkFailure() {
            console.log('Testing network failure recovery...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Network failure recovery...';
            
            mockSettings.responseType = 'error';
            mockSettings.failureRate = 1;
            
            jQuery('#primary_color').val('#ff0000').trigger('change');
            
            setTimeout(() => {
                mockSettings.responseType = 'success';
                mockSettings.failureRate = 0;
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Network failure recovery test finished';
                updateSystemStatus();
            }, 5000);
        }
        
        function testInvalidResponse() {
            console.log('Testing invalid response handling...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Invalid response handling...';
            
            mockSettings.responseType = 'invalid';
            
            jQuery('#secondary_color').val('#00ff00').trigger('change');
            
            setTimeout(() => {
                mockSettings.responseType = 'success';
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Invalid response handling test finished';
                updateSystemStatus();
            }, 3000);
        }
        
        function testMissingNonce() {
            console.log('Testing missing nonce handling...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Missing nonce handling...';
            
            var originalNonce = masV2Global.nonce;
            masV2Global.nonce = '';
            
            jQuery('#font_size').val('18').trigger('input');
            
            setTimeout(() => {
                masV2Global.nonce = originalNonce;
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Missing nonce handling test finished';
                updateSystemStatus();
            }, 2000);
        }
        
        function testEmptyCSS() {
            console.log('Testing empty CSS response...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Empty CSS response handling...';
            
            mockSettings.responseType = 'empty';
            
            jQuery('#border_radius').val('10').trigger('change');
            
            setTimeout(() => {
                mockSettings.responseType = 'success';
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Empty CSS response test finished';
                updateSystemStatus();
            }, 2000);
        }
        
        function testInvalidCSS() {
            console.log('Testing invalid CSS handling...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Invalid CSS handling...';
            
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                window.MASSimpleLivePreview.injectTestCSS('body { color: red; background: }'); // Invalid CSS
            }
            
            setTimeout(() => {
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Invalid CSS handling test finished';
                updateSystemStatus();
            }, 2000);
        }
        
        function testServerError() {
            console.log('Testing server error handling...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Server error handling...';
            
            mockSettings.responseType = 'malformed';
            
            jQuery('#theme_style').val('classic').trigger('change');
            
            setTimeout(() => {
                mockSettings.responseType = 'success';
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Server error handling test finished';
                updateSystemStatus();
            }, 3000);
        }
        
        function testCriticalFailure() {
            console.log('Testing critical failure recovery...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Testing:</strong> Critical failure recovery...';
            
            var backup = window.masV2Global;
            window.masV2Global = undefined;
            
            jQuery('#enable_animations').prop('checked', false).trigger('change');
            
            setTimeout(() => {
                window.masV2Global = backup;
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Test Complete:</strong> Critical failure recovery test finished';
                updateSystemStatus();
            }, 4000);
        }
        
        function restoreNormalOperation() {
            console.log('Restoring normal operation...');
            document.getElementById('error-test-results').innerHTML = 
                '<strong>Restoring:</strong> Normal operation...';
            
            mockSettings.responseType = 'success';
            mockSettings.failureRate = 0;
            
            if (typeof window.MASSimpleLivePreview !== 'undefined') {
                window.MASSimpleLivePreview.exitFallbackMode();
            }
            
            setTimeout(() => {
                document.getElementById('error-test-results').innerHTML = 
                    '<strong>Restored:</strong> Normal operation restored';
                updateSystemStatus();
                runHealthCheck();
            }, 1000);
        }
        
        // Initialize monitoring
        jQuery(document).ready(function() {
            setTimeout(function() {
                runHealthCheck();
                updateSystemStatus();
                
                // Set up periodic status updates
                setInterval(updateSystemStatus, 5000);
            }, 2000);
        });
    </script>
</body>
</html>